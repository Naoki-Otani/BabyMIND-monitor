<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML lang="ja">
<HEAD>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Script-Type" content="text/javascript; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<!--<meta http-equiv="refresh" content="60"> -->
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">

<TITLE>Baby MIND DAQ monitor</TITLE>

<STYLE type="text/css">
<!--
BODY {
  color: #000000;
  background-color: #FFFFFF;
  margin-left: 3em;
  margin-right: 3em;
}
A:link {color: #0000FF}
A:visited {color: #550088}
A:active {color: #990099}
A:hover {color: #009900}
.b{font-weight: bold}

/* ===== Operator warning (top message) ===== */
/* WARNING: Only ND280 shift leader and Baby MIND expert are allowed to operate the alarm switch. */
#mcr-operator-warning{
  /* position: sticky; */
  position: static;
  top: 0;
  z-index: 2000; /* above other sticky bars */
  margin: 10px 0 12px 0;
  padding: 10px 14px;
  border: 2px solid #990000;
  border-radius: 10px;
  background: #fff0f0;
  color: #990000;
  font-weight: 800;
  letter-spacing: 0.2px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
  text-align: center;
}

/* ===== Styles for MCR monitor (similar look & feel) ===== */
:root {
  --ok: #0ac70a;
  --warn: #d40000;
  --banner-ok-bg: #0b7a0b;
  --banner-warn-bg: #990000;
  --banner-fg: #ffffff;
}

table { border-collapse: collapse; }
td, th { border: 2px solid #000; padding: 0.4rem 0.6rem; }
th { background: #f0f0f0; text-align: left; }

.lamp {
  width: 26px; height: 26px; border-radius: 50%;
  display: inline-block; margin-left: 10px; vertical-align: middle;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  border: 2px solid #222;
}
.green { background-color: var(--ok); }
.red { background-color: var(--warn); }

/* ===== Unified status banner ===== */
#mcr-status-banner {
  /* position: sticky; top: 0; z-index: 1000; */
  position: static;
  display: block;
  color: var(--banner-fg);
  padding: 0.6rem 1rem; font-weight: 700; letter-spacing: 0.3px;
  border-radius: 8px; margin-bottom: 1rem; text-align: center;
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}
#mcr-status-banner.ok { background: var(--banner-ok-bg); }
#mcr-status-banner.warn {
  background: var(--banner-warn-bg);
  animation: blink 1.2s steps(2, start) infinite;
}
@keyframes blink { 50% { opacity: 0.2; } }

/* ===== Sound enable bar ===== */
#mcr-enable-bar {
  /* position: sticky; top: 0; z-index: 1001; */
  position: static;
  background: #f7f7f7; border: 1px solid #bbb; border-radius: 8px;
  padding: 8px 12px; margin-bottom: 10px; display: none;
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}
#mcr-enable-sound, #mcr-disable-sound {
  padding: 6px 12px; border: 1px solid #333; border-radius: 6px;
  background: #f5f5f5; cursor: pointer; font-weight: 600; margin-left: 8px;
}

/* ===== Global alarm status (button-like, non-clickable) ===== */
/* This makes the shared alarm ON/OFF state visible to all viewers. */
#mcr-global-state{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
  padding: 8px 12px;
  font-weight: 700;
  border: 2px solid #222;
  border-radius: 999px; /* pill shape */
  background: #f5f5f5;
  box-shadow: 0 4px 10px rgba(0,0,0,0.18);
  user-select: none;
  cursor: default; /* looks like a button, but not clickable */
}
/* Small dot indicator on the left */
#mcr-global-state::before{
  content: "";
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,0.45);
  box-shadow: 0 0 8px rgba(0,0,0,0.18);
  display: inline-block;
}
/* ON/OFF styles are applied via JS by toggling classes on #mcr-global-state */
#mcr-global-state.alarm-on{
  background: rgba(10,199,10,0.12);
}
#mcr-global-state.alarm-on::before{
  background: var(--ok);
}
#mcr-global-state.alarm-off{
  background: rgba(212,0,0,0.12);
}
#mcr-global-state.alarm-off::before{
  background: var(--warn);
}
#mcr-global-state.alarm-loading{
  background: rgba(0,0,0,0.06);
}
#mcr-global-state.alarm-loading::before{
  background: #777;
}

@keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.03)} 100%{transform:scale(1)} }

/* ===== Permission warning box (shown when user answers "No") ===== */
#mcr-auth-warning{
  display: none;
  margin: 10px 0 12px 0;
  padding: 10px 12px;
  border: 2px solid #990000;
  border-radius: 10px;
  background: rgba(212,0,0,0.10);
  font-weight: 700;
  box-shadow: 0 6px 16px rgba(0,0,0,0.18);
}
#mcr-auth-warning .title{
  display: block;
  margin-bottom: 6px;
  letter-spacing: 0.2px;
}
#mcr-auth-warning.blink{
  animation: blink 1.2s steps(2, start) infinite;
}
-->
</STYLE>
</HEAD>

<body>

<!-- ===================== Operator warning (top) ===================== -->
<!-- WARNING: Only ND280 shift leader and Baby MIND expert are allowed to operate the alarm switch. -->
<div id="mcr-operator-warning" role="alert" aria-live="assertive">
  ‚ö†Ô∏è <b>WARNING</b>:
  Only the ND280 shift leader and the Baby MIND expert are allowed to operate the alarm switch.
  <b>Anyone other than the ND280 shift leader and the Baby MIND expert must NOT touch the alarm switch.</b>
</div>


<HR SIZE="3">
<font size="+3"><B>Baby MIND DAQ monitor</B></font>
<HR SIZE="3">

<font size="+2">
  Last update is <span id="page-last-update">Loading...</span> (JST)
</font>


<!-- ===================== MCR datasize monitor UI ===================== -->
<div id="mcr-status-banner" class="ok" role="status" aria-live="polite">
  ‚úÖ All good: all MCR data sizes increased within the last 30 minutes.
</div>

<div id="mcr-enable-bar">
  <div id="mcr-global-state" class="alarm-loading">
    Alarm status: <span id="mcr-global-state-text">Loading...</span>
  </div>
  <br>


  <!-- Permission warning (shown only when user answers "No") -->
  <div id="mcr-auth-warning" role="alert" aria-live="assertive">
    <span class="title">‚ö†Ô∏è WARNING:</span>
    Only the ND280 shift leader and the Baby MIND expert are allowed to operate the alarm switch.
    Anyone other than the ND280 shift leader and the Baby MIND expert must NOT touch the alarm switch.
  </div>

  üîä To allow alarms to play automatically, please click:
  <button id="mcr-enable-sound">Enable sound (click once)</button>
  <button id="mcr-disable-sound">Disable sound</button>
 <!-- Button usage notes (English) -->
  <div id="mcr-sound-help" style="margin-top:8px; font-size:0.95rem;">
    <div><b>Enable sound:</b> Unlocks audio permission in your browser (required for automatic alarms).</div>
    <div><b>Test sound:</b> After enabling, this button toggles a test alarm sound ON/OFF.</div>
    <div><b>Disable sound:</b> Stops any sound immediately and disables alarms until you enable again.</div>
  </div>
</div>

<font size="+2"><B>MCR data size monitor (last 30 minutes)</B></font><br><br>

<table>
  <tr>
    <th>MCR</th>
    <th>OK?</th>
    <th>Last update time (JST)</th>
    <th>Latest data size [kB]</th>
    <th>Data size 30 min ago [kB]</th>
  </tr>
  <tbody id="mcr-table-body"></tbody>
</table>

<br>
<font size="+2"><B>Status Lamp:</B></font>
<span id="mcr-lamp" class="lamp green" aria-label="status lamp"></span>
<!-- Status lamp meaning (English) -->
<div id="mcr-lamp-help" style="margin-top:8px; font-size:0.95rem;">
  <div><b>Green:</b> All MCR data sizes increased within the last 30 minutes.</div>
  <div><b>Red:</b> At least one MCR data size did not increase within the last 30 minutes (alarm condition).</div>
</div>

<br><br>

<!-- ===================== Original plots ===================== -->
<table border="1">
  <tr>
    <th valign="top">
      <font size="+2">Data size (12 hours)</font><BR>
      <a href="../../wagasci/bmom/bmom_12.png" title="12 hours">
        <img id="img-bmom-12" src="../../wagasci/bmom/bmom_12.png" width="480">
      </a>
      <br>

      <font size="+2">Data speed (12 hours)</font><br>
      <a href="../../wagasci/bmom/bmom_12_speed.png" title="12 hours data speed">
        <img id="img-bmom-12speed" src="../../wagasci/bmom/bmom_12_speed.png" width="480">
      </a>
      <br>
    </th>

    <th valign="top">
      <font size="+2">Data size (2 hours)</font><BR>
      <a href="../../wagasci/bmom/bmom_2.png" title="2 hour">
        <img id="img-bmom-2" src="../../wagasci/bmom/bmom_2.png" width="480">
      </a>
      <br>

      <font size="+2">Data speed (2 hours)</font><BR>
      <a href="../../wagasci/bmom/bmom_2_speed.png" title="2 hour data speed">
        <img id="img-bmom-2speed" src="../../wagasci/bmom/bmom_2_speed.png" width="480">
      </a>
      <br>
    </th>
  </tr>

  <tr>
    <th colspan="2" valign="top">
      <font size="+2">DAQ control window</font><BR>
      <a href="../../wagasci/bmom/ctr.png" title="DAQ control window">
        <img id="img-ctr" src="../../wagasci/bmom/ctr.png" width="900">
      </a>
    </th>
  </tr>
</table>

<!-- ===================== Alarm sound ===================== -->
<!-- Pre-beep sound (played for 5 seconds) -->
<audio id="mcr-beep-sound" preload="auto">
  <source src="fanfare2_alarm.wav" type="audio/wav">
</audio>

<script>
  /* ===================== Settings =====================
     - IMPORTANT: DATASIZE_DIR_URL must be a URL path accessible from the browser.
     - Example:
       If this HTML is at .../bmom/index.html and text files are at .../bmom/datasize/mcr_0_12h.txt,
       then DATASIZE_DIR_URL = "datasize" is correct.
  */
  const MCR_COUNT = 8;                 // MCR 0..7
  const THRESHOLD_MINUTES = 30;        // Window to judge "stopped"
  const LINES_TO_CHECK = 10;           // ~30 minutes if 3-minute step
  const POLL_MS = 30000;               // Poll interval (30s)
  const DATASIZE_DIR_URL = "../../wagasci/bmom/datasize"; // <-- Change this if needed
  //const DATASIZE_DIR_URL = "datasize";
  let soundEnabled = false;
  let testAlarmPlaying = false;
  let lastIsOk = true;
  let realAlarmPlaying = false; // True only when the real alarm (NG) is playing

  const STATE_URL = "state/alarm_state.json";
  const SET_STATE_URL = "state/set_alarm_state.php";

  let audioUnlocked = false;
  let globalEnabled = true;

 /* ===================== Shared state helpers =====================
     - globalEnabled is shared across all PCs via STATE_URL / SET_STATE_URL
     - Browser audio permission (soundEnabled) is per-PC and cannot be shared
  */
  async function fetchGlobalEnabled() {
    try {
      const res = await fetch(STATE_URL + "?t=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch global state");
      const js = await res.json();
      if (typeof js.enabled === "boolean") globalEnabled = js.enabled;
      updateGlobalStateUI();
    } catch (e) {
      // If state file is not reachable, keep the last known value.
      updateGlobalStateUI();
    }
  }

  /* Optional (advanced) UI: A full "card" layout with meta (who/when). */
  /* Keep this as a reference in case you want a richer status display later. */
  // function updateGlobalStateCard(stateObj) {
  //   const card = document.getElementById("mcr-global-alarm");
  //   const text = document.getElementById("mcr-global-alarm-text");
  //   const meta = document.getElementById("mcr-global-alarm-meta");
  //   if (!card || !text) return;
  //
  //   const isOn = !!globalEnabled;
  //   card.classList.toggle("alarm-on", isOn);
  //   card.classList.toggle("alarm-off", !isOn);
  //   text.textContent = isOn ? "ALARM ON" : "ALARM OFF";
  //
  //   if (meta && stateObj) {
  //     const by = stateObj.updated_by ? String(stateObj.updated_by) : "";
  //     const at = stateObj.updated_at ? new Date(stateObj.updated_at * 1000) : null;
  //     const atStr = at ? at.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo", hour12: false }) : "";
  //     meta.textContent = (by || atStr) ? (`${by}${by && atStr ? " / " : ""}${atStr}`) : "";
  //   }
  // }

  async function setGlobalEnabled(enabled) {
    try {
      const res = await fetch(
        SET_STATE_URL
          + "?enabled=" + (enabled ? "1" : "0")
          + "&by=browser"
          + "&t=" + Date.now(),
        { cache: "no-store" }
      );
      if (!res.ok) throw new Error("Failed to set global state");
      const js = await res.json();
      if (typeof js.enabled === "boolean") globalEnabled = js.enabled;
      else globalEnabled = enabled;
    } catch (e) {
      globalEnabled = enabled;
    }
    updateGlobalStateUI();
  }

  /* ===================== UI helpers ===================== */

  function updateGlobalStateUI() {
    const chip = document.getElementById("mcr-global-state");
    const el = document.getElementById("mcr-global-state-text");
    if (!chip || !el) return;

    chip.classList.remove("alarm-on","alarm-off","alarm-loading");

    if (typeof globalEnabled !== "boolean") {
      chip.classList.add("alarm-loading");
      el.textContent = "Loading...";
      return;
    }

    if (globalEnabled) {
      chip.classList.add("alarm-on");
      el.textContent = "alarm on";
    } else {
      chip.classList.add("alarm-off");
      el.textContent = "alarm off";
    }
  }

  function setLamp(isOk) {
    const lamp = document.getElementById("mcr-lamp");
    if (!lamp) return;
    lamp.classList.toggle("green", isOk);
    lamp.classList.toggle("red", !isOk);
  }

  function setBanner(isOk, badList) {
    const banner = document.getElementById("mcr-status-banner");
    if (!banner) return;

    banner.classList.toggle("ok", isOk);
    banner.classList.toggle("warn", !isOk);

    banner.textContent = isOk
      ? "‚úÖ All good: all MCR data sizes increased within the last 30 minutes."
      : ("‚ö†Ô∏è Warning: NO size increase in last 30 minutes for: " + badList.join(", ") + " !");

    banner.setAttribute("role", isOk ? "status" : "alert");
    banner.setAttribute("aria-live", isOk ? "polite" : "assertive");
  }

  function unixToJstString(unixSec) {
    if (!unixSec || !isFinite(unixSec)) return "N/A";
    const d = new Date(unixSec * 1000);
    return d.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo", hour12: false });
  }

  /* Show the page refresh/load time in JST */
  function updatePageLastUpdateNow() {
    const el = document.getElementById("page-last-update");
    if (!el) return;
    const now = new Date();
    el.textContent = now.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo", hour12: false });
  }



  /* ===================== Parse logic ===================== */
  function parseTxt(text) {
    // Each line is: "<unixtime> <size>"
    const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const pairs = [];
    for (const ln of lines) {
      const m = ln.match(/^(\d+)\s+(\d+)/);
      if (m) pairs.push({ t: Number(m[1]), s: Number(m[2]) });
    }
    return pairs;
  }

  async function fetchTxt(url) {
    // Use cache: "no-store" to minimize stale content
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("Fetch failed " + res.status + ": " + url);
    return await res.text();
  }

  /* Update the top "Last update" using mcr_0_12h.txt Last-Modified (fallback: latest unixtime in file) */
  async function updatePageLastUpdateFromMcr0(nowMs) {
    const el = document.getElementById("page-last-update");
    if (!el) return;

    const url = DATASIZE_DIR_URL + "/mcr_0_12h.txt";

    try {
      // GET once (we already need the content sometimes); no-store to avoid stale headers/content
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed " + res.status);

      // 1) Prefer HTTP Last-Modified header (file modification time on the server)
      const lm = res.headers.get("Last-Modified");
      if (lm) {
        const d = new Date(lm);
        // If parsing succeeded, show it in JST
        if (!isNaN(d.getTime())) {
          el.textContent = d.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo", hour12: false });
          return;
        }
      }

      // 2) Fallback: use the latest unixtime in the file (data timestamp)
      const txt = await res.text();
      const pairs = parseTxt(txt);
      const latest = latestPoint(pairs);
      el.textContent = latest ? unixToJstString(latest.t) : "N/A";
    } catch {
      el.textContent = "N/A";
    }
  }


  /* Pick the data point closest to (now - THRESHOLD_MINUTES), but not newer than that target time */
  function pick30minAgoPoint(pairs, nowMs) {
    if (!pairs || pairs.length === 0) return null;

    const targetSec = Math.floor((nowMs - THRESHOLD_MINUTES * 60000) / 1000);

    // Find the newest point with timestamp <= targetSec
    // (Scan from the end for efficiency)
    for (let j = pairs.length - 1; j >= 0; j--) {
      if (pairs[j].t <= targetSec) return pairs[j];
    }

    // If all points are newer than target (file is too short / started recently),
    // fallback to the oldest point available.
    return pairs[0];
  }


  function latestPoint(pairs) {
    return pairs.length ? pairs[pairs.length - 1] : null;
  }

  /* Return the last point where the size changed (increase OR decrease) compared to the previous sample */
  function lastChangePoint(pairs) {
    if (!pairs || pairs.length < 2) return null;

    // Scan from the end: find the most recent index j where s[j] != s[j-1]
    for (let j = pairs.length - 1; j >= 1; j--) {
      if (pairs[j].s !== pairs[j - 1].s) return pairs[j];
    }

    // No change found (size is constant in the whole file)
    return null;
  }


  function ensureTableRows() {
    const tbody = document.getElementById("mcr-table-body");
    if (!tbody) return;
    if (tbody.children.length === MCR_COUNT) return;

    tbody.innerHTML = "";
    for (let i = 0; i < MCR_COUNT; i++) {
      const tr = document.createElement("tr");
      tr.innerHTML = ''
        + '<th scope="row">MCR ' + i + '</th>'
        + '<td id="mcr-ok-' + i + '">Loading...</td>'
        + '<td id="mcr-time-' + i + '">Loading...</td>'
        + '<td id="mcr-latest-' + i + '">Loading...</td>'
        + '<td id="mcr-ago-' + i + '">Loading...</td>';
      tbody.appendChild(tr);
    }
  }

  /* ===================== Alarm control ===================== */
  /* Start/stop alarm using a single audio element */
  async function startOrStopAlarm(shouldStart) {
    const beep = document.getElementById("mcr-beep-sound");
    if (!beep) return;

    if (shouldStart) {
      // Respect the shared (global) enable/disable flag.
      // If globally disabled, never play sound even on an NG state.
      if (!globalEnabled) return;

      // If sound is not enabled, show the enable bar and do not play
      if (!soundEnabled) {
        const bar = document.getElementById("mcr-enable-bar");
        const btn = document.getElementById("mcr-enable-sound");
        if (bar) bar.style.display = "block";
        if (btn) {
          btn.style.boxShadow = "0 0 0 3px rgba(255,0,0,0.35)";
          btn.style.animation = "pulse 1.5s infinite";
        }
        return;
      }

      try {
        beep.loop = true;
        await beep.play();
        realAlarmPlaying = true;
      } catch {
        // Autoplay may still be blocked; retry later
        setTimeout(() => startOrStopAlarm(true), 5000);
      }
    } else {
      beep.pause();
      beep.currentTime = 0;
      beep.loop = false;
      realAlarmPlaying = false;
    }
  }


  /* ===================== Main evaluation loop ===================== */
  async function evaluateMcrStatus() {
    ensureTableRows();

    const bad = [];
    const nowMs = Date.now();

    // Update shared enable/disable state each cycle.
    await fetchGlobalEnabled();

    // If someone disabled the alarm globally, stop the REAL alarm immediately on this PC.
    // (Test sound is per-PC and should not be affected.)
    if (!globalEnabled && realAlarmPlaying) {
      startOrStopAlarm(false);
    }

    for (let i = 0; i < MCR_COUNT; i++) {
      const url = DATASIZE_DIR_URL + "/mcr_" + i + "_12h.txt";

      const okCell = document.getElementById("mcr-ok-" + i);
      const timeCell = document.getElementById("mcr-time-" + i);
      const latestCell = document.getElementById("mcr-latest-" + i);
      const agoCell = document.getElementById("mcr-ago-" + i);

      try {
        const txt = await fetchTxt(url);
        const pairs = parseTxt(txt);

        const latest = latestPoint(pairs);
        const ago = pick30minAgoPoint(pairs, nowMs);
        const lastChg = lastChangePoint(pairs);

        // Decide OK/NG:
        // - Need enough data points
        // - Latest size must be greater than "30 minutes ago" size
        // - Latest timestamp must not be older than 30 minutes (extra safety)
        let isOk = false;
        if (latest && ago && lastChg) {
          // "OK" means: size changed (increase OR decrease) within the last 30 minutes
          // Use the timestamp when the size last increased (not the last line timestamp)
          const diffMin = (nowMs - lastChg.t * 1000) / 60000;
          isOk = (diffMin <= THRESHOLD_MINUTES);
        }

        if (!isOk) bad.push("MCR" + i);

        if (okCell) okCell.textContent = isOk ? "OK" : "NG";
        if (timeCell) timeCell.textContent = lastChg ? unixToJstString(lastChg.t) : "N/A";
        if (latestCell) latestCell.textContent = latest ? String(latest.s) : "N/A";
        if (agoCell) agoCell.textContent = ago ? String(ago.s) : "N/A";
      } catch {
        // Any fetch/parse error is treated as NG
        bad.push("MCR" + i);
        if (okCell) okCell.textContent = "NG (fetch/parse error)";
        if (timeCell) timeCell.textContent = "N/A";
        if (latestCell) latestCell.textContent = "N/A";
        if (agoCell) agoCell.textContent = "N/A";
      }
    }

    const allOk = (bad.length === 0);
    setLamp(allOk);
    setBanner(allOk, bad);

    // Do not stop the sound during "Test sound" mode.
    // But if the system becomes NG, override the test and start the real alarm.
    if (!allOk) {
      if (testAlarmPlaying) {
        testAlarmPlaying = false;
        const btnEnable = document.getElementById("mcr-enable-sound");
        if (btnEnable) btnEnable.textContent = "Test sound (click to start/stop)";
      }
      // Only try to play when globally enabled.
      if (globalEnabled) startOrStopAlarm(true);

    } else {
      if (!testAlarmPlaying) startOrStopAlarm(false);
    }

    lastIsOk = allOk;
  }

  /* ===================== Sound buttons ===================== */
  (function setupSoundButtons() {
    const bar = document.getElementById("mcr-enable-bar");
    const btnEnable = document.getElementById("mcr-enable-sound");
    const btnDisable = document.getElementById("mcr-disable-sound");
    const beep = document.getElementById("mcr-beep-sound");
    const warnBox = document.getElementById("mcr-auth-warning");

    /* Ask for permission before allowing alarm switch operations. */
    function confirmAuthorizedOrWarn() {
      // confirm() returns true for "OK" (= Yes), false for "Cancel" (= No)
      const ok = window.confirm("Are you ND280 shift leader or Baby MIND expert?");
      if (ok) {
        if (warnBox) {
          warnBox.style.display = "none";
          warnBox.classList.remove("blink");
        }
        return true;
      }

      // User answered "No": show warning message and block the operation.
      if (warnBox) {
        warnBox.style.display = "block";
        // Add blink to make it noticeable if repeatedly attempted.
        warnBox.classList.add("blink");
      }
      return false;
    }

    if (bar) bar.style.display = "block";

    if (btnEnable) {
      btnEnable.addEventListener("click", async () => {
        try {
          // Block unauthorized operations (global enable/disable is shared across PCs).
          if (!confirmAuthorizedOrWarn()) return;

          // First click: unlock audio permission
          if (!soundEnabled) {
            beep.volume = 0.01;
            beep.loop = false;
            await beep.play();
            await new Promise(r => setTimeout(r, 150));
            beep.pause();
            beep.currentTime = 0;
            beep.volume = 1.0;

            soundEnabled = true;
            btnEnable.textContent = "Test sound (click to start/stop)";
            btnEnable.style.boxShadow = "none";
            btnEnable.style.animation = "none";

            // Enable alarm globally (shared) when someone enables sound locally.
            // Note: Other PCs still need to click once to unlock audio permission.
            await setGlobalEnabled(true);

            // If current status is NG, start the real alarm immediately
            evaluateMcrStatus();
            return;
          }

          // After enabled: toggle manual test sound
          if (!testAlarmPlaying) {
            beep.loop = true;
            beep.currentTime = 0;
            await beep.play();
            testAlarmPlaying = true;
            btnEnable.textContent = "Stop test sound";
          } else {
            beep.pause();
            beep.currentTime = 0;
            beep.loop = false;
            testAlarmPlaying = false;
            btnEnable.textContent = "Test sound (click to start/stop)";
          }
        } catch {
          alert("Autoplay blocked. Please click again or check site permissions for sound.");
        }
      });
    }

    if (btnDisable) {
        btnDisable.addEventListener("click", async () => {
        // Block unauthorized operations.
        if (!confirmAuthorizedOrWarn()) return;

        // Disable alarm globally (shared), and also stop local sound immediately.
        await setGlobalEnabled(false);

        // Stop local sound immediately and revert to the initial local state
        soundEnabled = false;
        testAlarmPlaying = false;

        if (beep) {
          beep.pause();
          beep.currentTime = 0;
          beep.loop = false;
        }

        if (btnEnable) {
          btnEnable.textContent = "Enable sound (click once)";
          btnEnable.style.boxShadow = "none";
          btnEnable.style.animation = "none";
        }

        // Stop the alternating alarm loop immediately
        startOrStopAlarm(false);
      });
    }
  })();

  /* Force-reload PNG images by updating their src with a cache-busting query */
  function refreshMonitorImages(nowMs) {
    const ids = [
      "img-bmom-12",
      "img-bmom-12speed",
      "img-bmom-2",
      "img-bmom-2speed",
      "img-ctr",
    ];

    for (const id of ids) {
      const img = document.getElementById(id);
      if (!img) continue;

      // Keep the original URL (without old query) and append a new cache buster
      const base = img.src.split("?")[0];
      img.src = base + "?t=" + nowMs;
    }
  }


  /* ===================== Watchdogs ===================== */
  window.addEventListener("load", () => {
    const nowMs = Date.now();
    updatePageLastUpdateFromMcr0(nowMs);
    evaluateMcrStatus();
    refreshMonitorImages(nowMs);

    // Poll the shared alarm ON/OFF state more frequently than the main watchdog loop.
    // This makes changes from other PCs visible quickly.
    setInterval(() => {
      fetchGlobalEnabled(); // this should call updateGlobalStateUI() inside it
    }, 3000);

    setInterval(() => {
      const nowMs = Date.now();
      updatePageLastUpdateFromMcr0(nowMs);
      evaluateMcrStatus();
      refreshMonitorImages(nowMs);
    }, POLL_MS);
  });



  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) evaluateMcrStatus();
  });

  // If status is NG and sound is enabled but audio is paused for some reason, try to resume
  setInterval(() => {
    const beep = document.getElementById("mcr-beep-sound");
    // Refresh global state periodically, then try resume only if globally enabled.
    fetchGlobalEnabled().then(() => {
      // If globally disabled, stop the REAL alarm immediately.
      if (!globalEnabled && realAlarmPlaying) {
        startOrStopAlarm(false);
        return;
      }
      if (!lastIsOk && globalEnabled && soundEnabled && beep && beep.paused) {
        startOrStopAlarm(true);
      }
    });
  }, 10000);


</script>

</body>
</html>
